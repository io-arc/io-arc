#!/usr/bin/env node
/*!
Create a Service Worker

https://github.com/io-arc/io-arc/tasks/task-service-worker
Version: 0.0.1
License: ISC
Copyright (c) 2020 arc one
*/
"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=require("commander"),r=e(require("fs")),i=require("@io-arc/env"),n=require("rxjs"),s=require("rxjs/operators"),a=require("kleur"),o=e(require("@io-arc/logger")),u=e(require("cpx")),c=e(require("path"));var l,m,p,f,d,h=function(e,t){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return t.get(e)},w=function(e,t,r){if(!t.has(e))throw new TypeError("attempted to set private field on non-instance");return t.set(e,r),r};class g{constructor(){l.set(this,void 0),m.set(this,`${i.WS_ROOT_ABSOLUTE}/sw.js`),p.set(this,e=>{const{generateSW:t}=require("workbox-build");t(e).then(e=>{o.complete("service-worker"),o.message(`pre cache ${e.count} files, total ${h(this,d).call(this,e.size)}`)}).catch(e=>{o.failed("service-worker",e)})}),f.set(this,e=>{const t=1024,r=t**3,i=t**4;return e>=i?{denominator:i,unit:"TB"}:e>=r?{denominator:r,unit:"GB"}:e>=1048576?{denominator:1048576,unit:"MB"}:e>=t?{denominator:t,unit:"KB"}:{denominator:-1,unit:"byte"}}),d.set(this,e=>{const{denominator:t,unit:r}=h(this,f).call(this,e);return(t>-1?Math.floor(e/t*100)/100:e)+r});try{r.statSync(h(this,m)),w(this,l,!0)}catch(e){w(this,l,!1)}}exist(){return h(this,l)}run(){const e=require(h(this,m));n.of(e).pipe(s.map(e=>{if(null!=e.filename&&""!==e.filename||(e.filename="sw.js"),!/\.js$/.test(e.filename))throw new Error("Target filename wasn't JavaScrip file");return e}),s.map(e=>(e.manifest.globDirectory=i.DIST,e.manifest.swDest=`${i.DIST}/${e.filename}`,e.manifest))).subscribe(e=>{h(this,p).call(this,e)},e=>{o.message(e,a.red),process.exit(1)})}}l=new WeakMap,m=new WeakMap,p=new WeakMap,f=new WeakMap,d=new WeakMap,(()=>{if(t.program.version("0.0.1").option("-t, --template","generate template").parse(process.argv),t.program.template)return void function(){if(null==process.mainModule)return o.message("Missing main module",a.red),void process.exit(1);u.copy(`${c.dirname(process.mainModule.filename)}/template/sw.js`,i.WS_ROOT,e=>{if(e)return o.failed("create a service-worker",e),void process.exit(1);o.message("done !",a.blue),process.exit(0)})}();(new g).run()})();
