#!/usr/bin/env node
/*!
Run BrowserSync

https://github.com/io-arc/io-arc/tasks/task-browser-sync
Version: 0.0.2
License: ISC
Copyright (c) 2020 arc one
*/
"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var r=require("commander"),t=e(require("fs")),i=require("@io-arc/read-yaml"),s=require("rxjs"),o=require("rxjs/operators"),a=require("@io-arc/env"),n=e(require("browser-sync"));var h,c,d,p,l,v=function(e,r,t){if(!r.has(e))throw new TypeError("attempted to set private field on non-instance");return r.set(e,t),t},u=function(e,r){if(!r.has(e))throw new TypeError("attempted to get private field on non-instance");return r.get(e)};class y{constructor(e,r){h.set(this,void 0),c.set(this,void 0),d.set(this,void 0),p.set(this,e=>{try{return t.statSync(`${process.cwd()}/config/${e}`),e}catch(e){return}}),l.set(this,e=>s.of(e).pipe(o.map(e=>(void 0!==e.files||(e.files=`${a.DIST}/**/*`),e)),o.map(e=>void 0!==u(this,h)||void 0!==e.proxy?(void 0!==e.server&&delete e.server,void 0!==u(this,h)&&(e.proxy=u(this,h)),e):(void 0===e.server&&(e.server=`${a.DIST}/`),e)),o.map(e=>{if(void 0!==e.serveStatic)return e;const r=a.SITE_ROOT.replace(/\/$/,"");return""!==r&&(e.serveStatic=[{route:[r],dir:a.DIST}]),e}),o.map(e=>{if(void 0===u(this,c))return e;const r=require("connect-history-api-fallback")({index:u(this,c)});return e.middleware=[...r],e.single=!0,e}))),v(this,h,e),v(this,c,r),v(this,d,u(this,p).call(this,"browser-sync.yml")),void 0===u(this,d)&&(v(this,d,u(this,p).call(this,"browser-sync.yaml")),void 0===u(this,d)&&(v(this,d,u(this,p).call(this,"bs.yml")),void 0===u(this,d)&&v(this,d,u(this,p).call(this,"bs.yaml"))))}run(){const e=u(this,d)?i.ReadYaml(u(this,d),["config"]):{};u(this,l).call(this,e).subscribe(e=>{n(e)})}}h=new WeakMap,c=new WeakMap,d=new WeakMap,p=new WeakMap,l=new WeakMap,(()=>{r.program.version("0.0.2").option("-p, --proxy <ip-address>","Proxy server address").option("--history <filepath>","File paths used by the HTML5 HistoryAPI (e.g. /index.html)").parse(process.argv);const e=r.program.proxy||void 0,t=r.program.history||void 0;new y(e,t).run()})();
