#!/usr/bin/env node
/*!
Run BrowserSync

https://github.com/io-arc/io-arc/tasks/task-browser-sync
Version: 0.0.2
License: ISC
Copyright (c) 2020 arc one
*/
"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var r=require("commander"),t=e(require("fs")),i=require("@io-arc/read-yaml"),s=require("rxjs"),o=require("rxjs/operators"),n=require("@io-arc/env"),a=e(require("browser-sync"));var c,p,h,l,d,u=function(e,r,t){if(!r.has(e))throw new TypeError("attempted to set private field on non-instance");return r.set(e,t),t},v=function(e,r){if(!r.has(e))throw new TypeError("attempted to get private field on non-instance");return r.get(e)};class y{constructor(e,r){c.set(this,void 0),p.set(this,void 0),h.set(this,void 0),l.set(this,e=>{try{return t.statSync(`${process.cwd()}/config/${e}`),e}catch(e){return}}),d.set(this,e=>s.of(e).pipe(o.map(e=>(void 0!==e.files||(e.files=`${n.DIST}/**/*`),e)),o.map(e=>void 0!==v(this,c)||void 0!==e.proxy?(void 0!==e.server&&delete e.server,void 0!==v(this,c)&&(e.proxy=v(this,c)),e):(void 0===e.server&&(e.server=`${n.DIST}/`),e)),o.map(e=>{if(void 0!==e.serveStatic)return e;const r=n.SITE_ROOT.replace(/\/$/,"");return""!==r&&(e.serveStatic=[{route:[r],dir:n.DIST}]),e}),o.map(e=>{if(void 0===v(this,p))return e;console.log(v(this,p));const r=require("connect-history-api-fallback")({index:v(this,p)});return e.middleware=[r],e.single=!0,console.log(e),e}))),u(this,c,e),u(this,p,r),u(this,h,v(this,l).call(this,"browser-sync.yml")),void 0===v(this,h)&&(u(this,h,v(this,l).call(this,"bs.yml")),v(this,h))}run(){const e=v(this,h)?i.ReadYaml(v(this,h).replace(".yml",""),["config"]):{};v(this,d).call(this,e).subscribe(e=>{console.log("start"),console.log(e),a(e)})}}c=new WeakMap,p=new WeakMap,h=new WeakMap,l=new WeakMap,d=new WeakMap,(()=>{r.program.version("0.0.2").option("-p, --proxy <ip-address>","Proxy server address").option("--history <filepath>","File paths used by the HTML5 HistoryAPI (e.g. /index.html)").parse(process.argv);const e=r.program.proxy||void 0,t=r.program.history||void 0;new y(e,t).run()})();
